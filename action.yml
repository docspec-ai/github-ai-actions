name: "AI PR Automation"
description: "Runs AI code assistants (Claude Code or Codex) to create automated PRs based on merged PRs"
inputs:
  provider:
    description: "AI provider to use: 'claude' or 'codex'"
    required: false
    default: "claude"
  prompt_template:
    description: "Prompt template with variable placeholders ({{PR_DIFF}}, {{PR_TITLE}}, etc.)"
    required: true
  pr_number:
    description: "PR number to process. If not provided, will be extracted from the GitHub event context."
    required: false
  # Claude-specific inputs (matching anthropics/claude-code-action/base-action)
  anthropic_api_key:
    description: "Anthropic API key (required for direct Anthropic API)"
    required: false
    default: ""
  claude_code_oauth_token:
    description: "Claude Code OAuth token (alternative to anthropic_api_key)"
    required: false
    default: ""
  use_bedrock:
    description: "Use Amazon Bedrock with OIDC authentication instead of direct Anthropic API"
    required: false
    default: "false"
  use_vertex:
    description: "Use Google Vertex AI with OIDC authentication instead of direct Anthropic API"
    required: false
    default: "false"
  use_foundry:
    description: "Use Microsoft Foundry with OIDC authentication instead of direct Anthropic API"
    required: false
    default: "false"
  claude_args:
    description: "Additional arguments to pass directly to Claude CLI (e.g., '--max-turns 3 --mcp-config /path/to/config.json')"
    required: false
    default: ""
  settings:
    description: "Claude Code settings as JSON string or path to settings JSON file"
    required: false
    default: ""
  use_node_cache:
    description: "Whether to use Node.js dependency caching (set to true only for Node.js projects with lock files)"
    required: false
    default: "false"
  path_to_claude_code_executable:
    description: "Optional path to a custom Claude Code executable. If provided, skips automatic installation and uses this executable instead."
    required: false
    default: ""
  path_to_bun_executable:
    description: "Optional path to a custom Bun executable. If provided, skips automatic Bun installation and uses this executable instead."
    required: false
    default: ""
  show_full_output:
    description: "Show full JSON output from Claude Code. WARNING: This outputs ALL Claude messages including tool execution results which may contain secrets, API keys, or other sensitive information."
    required: false
    default: "false"
  plugins:
    description: "Newline-separated list of Claude Code plugin names to install (e.g., 'code-review@claude-code-plugins\nfeature-dev@claude-code-plugins')"
    required: false
    default: ""
  plugin_marketplaces:
    description: "Newline-separated list of Claude Code plugin marketplace Git URLs to install from"
    required: false
    default: ""
  # Codex-specific inputs
  openai_api_key:
    description: "OpenAI API key for Codex"
    required: false
  responses_api_endpoint:
    description: "Optional Responses API endpoint override for Codex"
    required: false
  codex_args:
    description: "Extra arguments forwarded to codex exec"
    required: false
    default: ""
  codex_sandbox:
    description: "Sandbox mode for Codex: workspace-write, read-only, or danger-full-access"
    required: false
    default: "workspace-write"
  codex_safety_strategy:
    description: "Safety strategy for Codex: drop-sudo, unprivileged-user, read-only, or unsafe"
    required: false
    default: "drop-sudo"
  # Common inputs
  branch_prefix:
    description: "Prefix for generated branches"
    required: false
    default: "ai/"
  pr_title_template:
    description: "Template for created PR title (supports variable placeholders)"
    required: false
    default: "chore: Automated changes from PR #{{PR_NUMBER}}"
  pr_body_template:
    description: "Template for created PR body (supports variable placeholders)"
    required: false
    default: "This PR contains automated changes generated by AI based on merged PR #{{PR_NUMBER}}."
  base_branch:
    description: "Base branch to create new branch from (defaults to repository default branch)"
    required: false
  github_token:
    description: "GitHub API token (pass secrets.GITHUB_TOKEN from your workflow)"
    required: true
  # Plan phase inputs
  enable_plan:
    description: "Enable plan phase before implementation (runs LLM twice: once for planning, once for implementation)"
    required: false
    default: "false"
  plan_prompt_template:
    description: "Optional prompt template for the plan phase. If not provided, uses a default plan prompt."
    required: false
  plan_claude_args:
    description: "Additional arguments to pass directly to Claude CLI for plan phase (e.g., '--model claude-opus-4-1-20250805 --max-turns 3')"
    required: false
    default: ""
outputs:
  branch_name:
    description: "Name of the branch created by the AI assistant"
    value: ${{ steps.delegate.outputs.branch_name }}
  has_changes:
    description: "Whether the AI assistant made any changes"
    value: ${{ steps.delegate.outputs.has_changes }}
runs:
  using: "composite"
  steps:
    - name: Run AI automation
      id: delegate
      uses: docspec-ai/github-ai-actions/.github/actions/ai-automation@main
      with:
        provider: ${{ inputs.provider }}
        prompt_template: ${{ inputs.prompt_template }}
        pr_number: ${{ inputs.pr_number }}
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        claude_code_oauth_token: ${{ inputs.claude_code_oauth_token }}
        use_bedrock: ${{ inputs.use_bedrock }}
        use_vertex: ${{ inputs.use_vertex }}
        use_foundry: ${{ inputs.use_foundry }}
        claude_args: ${{ inputs.claude_args }}
        settings: ${{ inputs.settings }}
        use_node_cache: ${{ inputs.use_node_cache }}
        path_to_claude_code_executable: ${{ inputs.path_to_claude_code_executable }}
        path_to_bun_executable: ${{ inputs.path_to_bun_executable }}
        show_full_output: ${{ inputs.show_full_output }}
        plugins: ${{ inputs.plugins }}
        plugin_marketplaces: ${{ inputs.plugin_marketplaces }}
        plan_claude_args: ${{ inputs.plan_claude_args }}
        openai_api_key: ${{ inputs.openai_api_key }}
        responses_api_endpoint: ${{ inputs.responses_api_endpoint }}
        codex_args: ${{ inputs.codex_args }}
        codex_sandbox: ${{ inputs.codex_sandbox }}
        codex_safety_strategy: ${{ inputs.codex_safety_strategy }}
        branch_prefix: ${{ inputs.branch_prefix }}
        pr_title_template: ${{ inputs.pr_title_template }}
        pr_body_template: ${{ inputs.pr_body_template }}
        base_branch: ${{ inputs.base_branch }}
        github_token: ${{ inputs.github_token }}
        enable_plan: ${{ inputs.enable_plan }}
        plan_prompt_template: ${{ inputs.plan_prompt_template }}
        plan_claude_args: ${{ inputs.plan_claude_args }}
        settings: ${{ inputs.settings }}
        use_node_cache: ${{ inputs.use_node_cache }}
        path_to_claude_code_executable: ${{ inputs.path_to_claude_code_executable }}
        path_to_bun_executable: ${{ inputs.path_to_bun_executable }}
        show_full_output: ${{ inputs.show_full_output }}
        plugins: ${{ inputs.plugins }}
        plugin_marketplaces: ${{ inputs.plugin_marketplaces }}
