name: "AI PR Automation"
description: "Runs AI code assistants (Claude Code or Codex) to create automated PRs based on merged PRs"
inputs:
  provider:
    description: "AI provider to use: 'claude' or 'codex'"
    required: false
    default: "claude"
  prompt_template:
    description: "Prompt template with variable placeholders ({{PR_DIFF}}, {{PR_TITLE}}, etc.)"
    required: true
  pr_number:
    description: "PR number to process. If not provided, will be extracted from the GitHub event context."
    required: false
  # Claude-specific inputs
  anthropic_api_key:
    description: "Anthropic API key for Claude Code"
    required: false
  claude_code_oauth_token:
    description: "Claude Code OAuth token (alternative to anthropic_api_key)"
    required: false
  use_bedrock:
    description: "Use Amazon Bedrock instead of direct Anthropic API"
    required: false
    default: "false"
  use_vertex:
    description: "Use Google Vertex AI instead of direct Anthropic API"
    required: false
    default: "false"
  use_foundry:
    description: "Use Microsoft Foundry instead of direct Anthropic API"
    required: false
    default: "false"
  claude_args:
    description: "Additional arguments to pass to Claude Code CLI"
    required: false
    default: ""
  # Codex-specific inputs
  openai_api_key:
    description: "OpenAI API key for Codex"
    required: false
  responses_api_endpoint:
    description: "Optional Responses API endpoint override for Codex"
    required: false
  codex_args:
    description: "Extra arguments forwarded to codex exec"
    required: false
    default: ""
  codex_sandbox:
    description: "Sandbox mode for Codex: workspace-write, read-only, or danger-full-access"
    required: false
    default: "workspace-write"
  codex_safety_strategy:
    description: "Safety strategy for Codex: drop-sudo, unprivileged-user, read-only, or unsafe"
    required: false
    default: "drop-sudo"
  # Common inputs
  branch_prefix:
    description: "Prefix for generated branches"
    required: false
    default: "ai/"
  pr_title_template:
    description: "Template for created PR title (supports variable placeholders)"
    required: false
    default: "chore: Automated changes from PR #{{PR_NUMBER}}"
  pr_body_template:
    description: "Template for created PR body (supports variable placeholders)"
    required: false
    default: "This PR contains automated changes generated by AI based on merged PR #{{PR_NUMBER}}."
  base_branch:
    description: "Base branch to create new branch from (defaults to repository default branch)"
    required: false
  github_token:
    description: "GitHub API token (pass ${{ secrets.GITHUB_TOKEN }})"
    required: true
outputs:
  branch_name:
    description: "Name of the branch created by the AI assistant"
    value: ${{ steps.ai-execution.outputs.branch_name }}
  has_changes:
    description: "Whether the AI assistant made any changes"
    value: ${{ steps.ai-execution.outputs.has_changes }}
runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Install Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install dependencies
      shell: bash
      working-directory: ${{ github.action_path }}
      run: bun install

    - name: Extract PR number from event
      id: extract-pr-number
      shell: bash
      run: |
        # If pr_number is explicitly provided, use it
        if [ -n "${{ inputs.pr_number }}" ] && [ "${{ inputs.pr_number }}" != "" ]; then
          echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          echo "Using explicitly provided PR number: ${{ inputs.pr_number }}"
          exit 0
        fi

        # Try to extract from different event types
        # PR events (pull_request, pull_request_target)
        if [ -n "${{ github.event.pull_request.number }}" ] && [ "${{ github.event.pull_request.number }}" != "" ]; then
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "Extracted PR number from pull_request event: ${{ github.event.pull_request.number }}"
          exit 0
        fi

        # Issue comment events (could be on a PR)
        if [ -n "${{ github.event.issue.number }}" ] && [ "${{ github.event.issue.number }}" != "" ]; then
          # Check if the issue is actually a PR by querying the GitHub API
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          API_RESPONSE=$(curl -s -f -H "Authorization: token ${{ inputs.github_token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${GITHUB_API_URL}/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}" || echo "")
          
          if [ -n "$API_RESPONSE" ]; then
            # Extract PR number from the response (if it's a PR, pull_request.url will be present)
            PR_NUMBER=$(echo "$API_RESPONSE" | jq -r 'if .pull_request and .pull_request.url then (.pull_request.url | split("/") | last) else empty end' 2>/dev/null || echo "")
            
            if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ] && [ "$PR_NUMBER" != "" ]; then
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
              echo "Extracted PR number from issue comment: $PR_NUMBER"
              exit 0
            else
              echo "Issue #${ISSUE_NUMBER} is not a pull request" >&2
            fi
          else
            echo "Failed to fetch issue #${ISSUE_NUMBER} from API" >&2
          fi
        fi

        # If we get here, we couldn't extract a PR number
        echo "Error: Could not extract PR number from event context" >&2
        echo "Event name: ${{ github.event_name }}" >&2
        echo "Please provide pr_number input explicitly, or trigger from a PR-related event" >&2
        exit 1

    - name: Prepare prompt with PR data
      id: prepare-prompt
      shell: bash
      working-directory: ${{ github.action_path }}
      run: bun run scripts/prepare-prompt.ts
      env:
        PROMPT_TEMPLATE: ${{ inputs.prompt_template }}
        PR_NUMBER: ${{ steps.extract-pr-number.outputs.pr_number }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
        REPOSITORY: ${{ github.repository }}
        BASE_BRANCH: ${{ inputs.base_branch || '' }}

    # Claude Code execution
    - name: Run Claude Code
      id: claude-code
      if: inputs.provider == 'claude'
      uses: anthropics/claude-code-action@v1
      with:
        prompt: ${{ steps.prepare-prompt.outputs.final_prompt }}
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        claude_code_oauth_token: ${{ inputs.claude_code_oauth_token }}
        use_bedrock: ${{ inputs.use_bedrock }}
        use_vertex: ${{ inputs.use_vertex }}
        use_foundry: ${{ inputs.use_foundry }}
        base_branch: ${{ steps.prepare-prompt.outputs.base_branch }}
        branch_prefix: ${{ inputs.branch_prefix }}
        claude_args: ${{ inputs.claude_args }}

    # Codex execution
    - name: Create branch for Codex
      id: codex-branch
      if: inputs.provider == 'codex'
      shell: bash
      run: |
        BASE_BRANCH="${{ steps.prepare-prompt.outputs.base_branch }}"
        BRANCH_PREFIX="${{ inputs.branch_prefix }}"
        PR_NUMBER="${{ steps.prepare-prompt.outputs.pr_number }}"
        BRANCH_NAME="${BRANCH_PREFIX}pr-${PR_NUMBER}-$(date +%s)"

        git fetch origin "$BASE_BRANCH"
        git checkout -b "$BRANCH_NAME" "origin/$BASE_BRANCH" || git checkout -b "$BRANCH_NAME"
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}

    - name: Run Codex
      id: codex-exec
      if: inputs.provider == 'codex'
      uses: openai/codex-action@v1
      with:
        openai-api-key: ${{ inputs.openai_api_key }}
        responses-api-endpoint: ${{ inputs.responses_api_endpoint }}
        prompt: ${{ steps.prepare-prompt.outputs.final_prompt }}
        sandbox: ${{ inputs.codex_sandbox }}
        safety-strategy: ${{ inputs.codex_safety_strategy }}
        codex-args: ${{ inputs.codex_args }}

    - name: Commit and push Codex changes
      id: codex-commit
      if: inputs.provider == 'codex'
      shell: bash
      run: |
        BRANCH_NAME="${{ steps.codex-branch.outputs.branch_name }}"

        # Check if there are any changes
        if [ -n "$(git status --porcelain)" ]; then
          git config user.name "github-ai-actions[bot]"
          git config user.email "github-ai-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: Automated changes from Codex for PR #${{ steps.prepare-prompt.outputs.pr_number }}"
          git push origin "$BRANCH_NAME"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected, skipping PR creation"
        fi

    # Set unified outputs
    - name: Set AI execution outputs
      id: ai-execution
      shell: bash
      run: |
        if [ "${{ inputs.provider }}" == "claude" ]; then
          if [ -n "${{ steps.claude-code.outputs.branch_name }}" ]; then
            echo "branch_name=${{ steps.claude-code.outputs.branch_name }}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        elif [ "${{ inputs.provider }}" == "codex" ]; then
          if [ "${{ steps.codex-commit.outputs.has_changes }}" == "true" ]; then
            echo "branch_name=${{ steps.codex-commit.outputs.branch_name }}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Create PR if changes exist
      if: steps.ai-execution.outputs.has_changes == 'true'
      shell: bash
      working-directory: ${{ github.action_path }}
      run: bun run scripts/create-pr.ts
      env:
        BRANCH_NAME: ${{ steps.ai-execution.outputs.branch_name }}
        BASE_BRANCH: ${{ steps.prepare-prompt.outputs.base_branch }}
        PR_TITLE_TEMPLATE: ${{ inputs.pr_title_template }}
        PR_BODY_TEMPLATE: ${{ inputs.pr_body_template }}
        PR_NUMBER: ${{ steps.prepare-prompt.outputs.pr_number }}
        PR_TITLE: ${{ steps.prepare-prompt.outputs.pr_title }}
        PR_AUTHOR: ${{ steps.prepare-prompt.outputs.pr_author }}
        PR_BODY: ${{ steps.prepare-prompt.outputs.pr_body }}
        REPOSITORY: ${{ github.repository }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
